<html lang="en" >

<!-- Mirrored from www.vbaccelerator.com/home/VB/Code/Controls/Drop_Down_Tool_Windows/Drop_Down_Form_Control/VB5_Drop_Down_Form_Control_Full_Source_zip_mTitleBarMod_bas.asp by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Jun 2015 21:30:54 GMT -->
<head>
<title>vbAccelerator - Contents of code file: mTitleBarMod.bas</title><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta name="AUTHOR" content="Steve McMahon" /><meta name="KEYWORDS" content=".NET, .NET Framework, C#, CSharp, VB, Visual Basic, VB5, VB6, Visual Basic, Active X, Controls, Components" /><meta name="DESCRIPTION" content="vbAccelerator - Contents of code file: mTitleBarMod.bas" /><link rel="stylesheet" href="../../../../../res/screen.css" media="SCREEN" /><link rel="stylesheet" href="../../../../../res/print.css" media="PRINT" /></head><body>
<table>
<tr class="adbar" bgcolor="#83726a"><tr class="footer"><td></td>
<td>
<p class="center">

<script type="text/javascript"><!--
google_ad_client = "pub-4690375644913255";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_ad_type = "text_image";
google_color_border = "336699";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_url = "008000.html";
google_color_text = "000000";
//--></script>
<script type="text/javascript"
  src="../../../../../../../pagead2.googlesyndication.com/pagead/f.txt">
</script>
</p>
</td>
<td></td>
</tr></tr><tr class="navbar"><td><a href="http://www.vbaccelerator.com/home/index.asp"><img width="125" height="25" src="../../../../../res/vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="http://www.vbaccelerator.com/home/index.asp">Home</a>&#160;.&#160;<a href="../../../../index.html">VB</a>&#160;.&#160;<a href="../../../index.html">Code</a>&#160;.&#160;<a href="../../index.html">Controls</a>&#160;.&#160;<a href="../index.html">Drop Down Tool Windows</a>&#160;.&#160;<a href="article.html">vbAccelerator Drop-Down and Popup Form Control</a>&#160;.&#160;<a href="VB5_Drop_Down_Form_Control_Full_Source.html">VB5 Drop Down Form Control Full Source</a>&#160;.&#160;mTitleBarMod.bas</p></td><td></td></tr><tr class="navbar"><td colspan="3"><hr /></td></tr><tr valign="top"><td class="sidebar"><img src="../../../../../res/download.png" width="125" height="21" alt="Downloads" /><p class="nav"><a href="VB5_Drop_Down_Form_Control_Binary.html"><img src="../../../../../res/get.png" width="8" height="8" alt="Download Page" />VB5 Drop Down Form Control Binary</a> (18K)</p><p class="nav"><a href="VB5_Drop_Down_Form_Control_Demonstration.html"><img src="../../../../../res/get.png" width="8" height="8" alt="Download Page" />VB5 Drop Down Form Control Demonstration</a> (44K)</p><p class="nav"><a href="VB5_Drop_Down_Form_Control_Full_Source.html"><img src="../../../../../res/get.png" width="8" height="8" alt="Download Page" />VB5 Drop Down Form Control Full Source</a> (81K)</p><p /><p class="nav"><a href="VB6_Drop_Down_Form_Control_Binary.html"><img src="../../../../../res/get.png" width="8" height="8" alt="Download Page" />VB6 Drop Down Form Control Binary</a> (19K)</p><p class="nav"><a href="VB6_Drop_Down_Form_Control_Demonstration.html"><img src="../../../../../res/get.png" width="8" height="8" alt="Download Page" />VB6 Drop Down Form Control Demonstration</a> (48K)</p><p class="nav"><a href="VB6_Drop_Down_Form_Control_Full_Source.html"><img src="../../../../../res/get.png" width="8" height="8" alt="Download Page" />VB6 Drop Down Form Control Full Source</a> (86K)</p><br /><br /><img src="../../../../../res/information.png" width="125" height="21" alt="Information" /><p class="nav">Zip:1088</p><p class="nav">&#160;&#160;<a href="http://www.vbaccelerator.com/linkto.asp?id=1088&amp;type=Zip&amp;title=VB5%20Drop%20Down%20Form%20Control%20Full%20Source%2Ezip%5FmTitleBarMod">Link to code Zip</a></p><p class="nav">Applies To:</p><p class="nav">&#160;&#160;VB5</p><p class="nav">Author:</p><p class="nav">&#160;&#160;<a href="mailto:steve@vbaccelerator.com">Steve McMahon</a></p><br /><br /><img src="../../../../../res/bugTrak.png" width="125" height="21" alt="BugTrak System" /><p class="nav">No logged bugs.</p><br /><br /><img src="../../../../../res/updates.png" width="125" height="21" alt="Updates" /><p class="nav"><img src="../../../../../res/update.png" width="8" height="8" alt="Update" />21 Mar 2000<br />First Posted</p><br /><br /><img src="../../../../../res/related.png" width="125" height="21" alt="Related Items" />﻿<p class="nav"><img src="../../../../../res/rel.png" width="8" height="8" alt="Related Item" /><a href="http://www.vbaccelerator.com/article.asp?id=13011">Emulating Modal Forms</a></p><p class="nav"><img src="../../../../../res/rel.png" width="8" height="8" alt="Related Item" /><a href="http://www.vbaccelerator.com/article.asp?id=1185">Creating drop-down tool windows</a></p><p class="nav"><img src="../../../../../res/rel.png" width="8" height="8" alt="Related Item" /><a href="http://www.vbaccelerator.com/article.asp?id=17">Subclassing Without The Crashes</a></p><br /><br /><img src="../../../../../res/search.png" width="125" height="21" alt="Search" />
<!-- Search Google -->
<form method="GET" action="http://www.google.com/custom">
<a href="http://www.google.com/search"><img src="../../../../../../../www.google.com/logos/Logo_40wht.gif" alt="Google" /></A><br />
<input type="text" name="q" size="31" maxlength="255" value="" class="search" /><br />
<input type="submit" name="sa" value="Search Google" class="search" />
<input type="hidden" name="cof" value="T:black;LW:330;ALC:990000;L:http://www.vbaccelerator.com/images/accl9.gif;LC:660000;LH:66;BGC:white;AH:left;VLC:999966;S:http://vbaccelerator.com/;GALT:999966;AWFID:67c7759ff27e5395;" />
<input type="hidden" name="domains" value="vbaccelerator.com" /><br />
<p class="nav"><input type="radio" name="sitesearch" value="" />Search WWW<br /></p>
<p class="nav"><input type="radio" name="sitesearch" value="vbaccelerator.com" checked="true" />vbAccelerator<br /></p>
</FORM>
<!-- Search Google -->
<br /><br />

<a href="http://www.vbaccelerator.com/home/The_Site/NewSite/article.asp"><img src="../../../../../res/newsite.png" width="125" height="129" alt="The New Site" /></a>
<br /><br />
</td><td width="100%" valign="top"><h1>vbAccelerator - Contents of code file: mTitleBarMod.bas</h1><pre>Attribute VB_Name = "mTitleBarMod"
Option Explicit



Private Declare Function GetProp Lib "user32" Alias "GetPropA" (ByVal hwnd As
 Long, ByVal lpString As String) As Long
Private Declare Function SetProp Lib "user32" Alias "SetPropA" (ByVal hwnd As
 Long, ByVal lpString As String, ByVal hData As Long) As Long
Private Declare Function RemoveProp Lib "user32" Alias "RemovePropA" (ByVal
 hwnd As Long, ByVal lpString As String) As Long

Private Declare Sub CopyMemory Lib "kernel32" Alias "RtlMoveMemory" ( _
    lpvDest As Any, lpvSource As Any, ByVal cbCopy As Long)

Private Declare Function CallWindowProc Lib "user32" Alias "CallWindowProcA"
 (ByVal lpPrevWndFunc As Long, ByVal hwnd As Long, ByVal Msg As Long, ByVal
 wParam As Long, ByVal lParam As Long) As Long

Private Declare Function GetWindowLong Lib "user32" Alias "GetWindowLongA"
 (ByVal hwnd As Long, ByVal nIndex As Long) As Long
Private Declare Function SetWindowLong Lib "user32" Alias "SetWindowLongA"
 (ByVal hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long

Private Const GWL_STYLE = (-16)
Private Const GWL_EXSTYLE = (-20)
Private Const GWL_WNDPROC = (-4)

Private Declare Function GetWindow Lib "user32" (ByVal hwnd As Long, ByVal wCmd
 As Long) As Long
Private Const GW_OWNER = 4
Private Const GW_HWNDNEXT = 2

Private Declare Function ShowWindow Lib "user32" (ByVal hwnd As Long, ByVal
 nCmdShow As Long) As Long
Private Declare Function SetActiveWindow Lib "user32" (ByVal hwnd As Long) As
 Long
Private Declare Function GetActiveWindow Lib "user32" () As Long
Private Declare Function IsWindowVisible Lib "user32" (ByVal hwnd As Long) As
 Long

Private Declare Function SendMessage Lib "user32" Alias "SendMessageA" (ByVal
 hwnd As Long, ByVal wMsg As Long, ByVal wParam As Long, lParam As Any) As Long

Private Declare Function DefWindowProc Lib "user32" Alias "DefWindowProcA"
 (ByVal hwnd As Long, ByVal wMsg As Long, ByVal wParam As Long, ByVal lParam As
 Long) As Long

Private Const WM_WINDOWPOSCHANGING = &amp;H46
Private Const WM_NCACTIVATE = &amp;H86
Private Const WM_ACTIVATEAPP = &amp;H1C
Private Const WM_SHOWWINDOW = &amp;H18

Private Const WS_VISIBLE = &amp;H10000000


Public Sub AttachTitleBarMod(ByVal hwnd As Long)
Dim lhWndVBOwn As Long
Dim lSubClassWnd As Long
Dim lCount As Long

   lhWndVBOwn = GetWindow(hwnd, GW_OWNER)
   
   InstallWndProc lhWndVBOwn, hwnd, plAddressOf(AddressOf WndProc)
   
   lCount = GetProp(lhWndVBOwn, "AttachCount")
   lCount = lCount + 1
   SetProp lhWndVBOwn, "AttachCount", lCount
   SetProp lhWndVBOwn, "Attach" &amp; lCount, hwnd
   SetProp lhWndVBOwn, "WndProc" &amp; lCount, plAddressOf(AddressOf WndProc)
   
End Sub
Public Sub DetachTitleBarMod(ByVal hwnd As Long)
Dim lhWndVBOwn As Long
Dim lSubClassWnd As Long
Dim bNoSubclass As Boolean
Dim i As Long
Dim lIdx As Long
Dim lCount As Long

   lhWndVBOwn = GetWindow(hwnd, GW_OWNER)
   
   lSubClassWnd = GetProp(lhWndVBOwn, "SubclassWnd")
   If lSubClassWnd = hwnd Then
      SetProp lhWndVBOwn, "SubclassWnd", 0
      bNoSubclass = True
   End If
   
   lCount = GetProp(lhWndVBOwn, "AttachCount")
   For i = 1 To lCount
      If GetProp(lhWndVBOwn, "Attach" &amp; i) = hwnd Then
         lIdx = i
         Exit For
      End If
   Next i
   
   If lCount = 1 Then
      ' Time to clear up
      RemoveProp lhWndVBOwn, "SubclassWnd"
      RemoveProp lhWndVBOwn, "AttachCount"
      RemoveProp lhWndVBOwn, "Attach1"
      RemoveProp lhWndVBOwn, "WndProc1"
      InstallWndProc lhWndVBOwn, 0, 0
   Else
      ' Still some left:
      For i = lIdx To lCount - 1
         SetProp lhWndVBOwn, "Attach" &amp; i, GetProp(lhWndVBOwn, "Attach" &amp; i + 1)
         SetProp lhWndVBOwn, "WndProc" &amp; i, GetProp(lhWndVBOwn, "WndProc" &amp; i +
          1)
      Next i
      RemoveProp lhWndVBOwn, "Attach" &amp; lCount
      RemoveProp lhWndVBOwn, "WndProc" &amp; lCount
      lCount = lCount - 1
      SetProp lhWndVBOwn, "AttachCount", lCount
      
      If bNoSubclass Then
         ' Tx to hWnd1:
         InstallWndProc lhWndVBOwn, GetProp(lhWndVBOwn, "Attach1"),
          GetProp(lhWndVBOwn, "WndProc1")
      End If
      
   End If

End Sub
Private Sub InstallWndProc(ByVal hWndVBOwner As Long, ByVal hwnd As Long, ByVal
 lPtr As Long)
Dim lPtrOrig As Long
Dim iCount As Long, i As Long

   lPtrOrig = GetProp(hWndVBOwner, "OrigWndProc")
   
   If hwnd = 0 Then
      If Not (lPtrOrig = 0) Then
         ' Restore:
         Debug.Print "...Restoring Original WndProc"
         SetWindowLong hWndVBOwner, GWL_WNDPROC, lPtrOrig
      End If
      RemoveProp hWndVBOwner, "OrigWndProc"
      RemoveProp hWndVBOwner, "SubclassWnd"
      ' Normally we expect iCount to be zero here.
      ' However, this will ensure we can detach
      ' everything *regardless* of whether we are
      ' detaching in an order manner
      iCount = GetProp(hWndVBOwner, "AttachCount")
      Debug.Print "AttachCount:"; iCount
      For i = 1 To iCount
         RemoveProp hWndVBOwner, "Attach" &amp; i
         RemoveProp hWndVBOwner, "WndProc" &amp; i
      Next i
      Debug.Print "Cleared"
      
   Else
      Debug.Print "Setting WndProc"
      If lPtrOrig = 0 Then
         ' New subclass:
         Debug.Print "...Installing WndProc"
         lPtrOrig = SetWindowLong(hWndVBOwner, GWL_WNDPROC, lPtr)
         Debug.Print "...Storing Original WndProc", lPtrOrig
         SetProp hWndVBOwner, "OrigWndProc", lPtrOrig
         Debug.Print GetProp(hWndVBOwner, "OrigWndProc")
      End If
   End If
   
End Sub
Private Function plAddressOf(ByVal lPtr As Long) As Long
   plAddressOf = lPtr
End Function
Private Function WndProc(ByVal hwnd As Long, ByVal iMsg As Long, ByVal wParam
 As Long, ByVal lParam As Long) As Long
Dim lhWNdOwner As Long
Dim lhWnd As Long
Dim lPtr As Long
Dim lS As Long
Static bInHere As Boolean
   '
   Select Case iMsg
   Case WM_WINDOWPOSCHANGING
      WndProc = DefWindowProc(hwnd, iMsg, wParam, lParam)
      If Not bInHere Then
         bInHere = True
         lhWNdOwner = GetWindow(GetActiveWindow(), GW_OWNER)
         If lhWNdOwner = hwnd Then
            ' Top level:
            Debug.Print "TopLevel"
            If IsWindowVisible(hwnd) = 0 Then
               lS = GetWindowLong(hwnd, GWL_STYLE)
               SetWindowLong hwnd, GWL_STYLE, lS Or WS_VISIBLE
            End If
         Else
            ' Not top level:
            Debug.Print "NotTopLevel"
            ' Top level VB window:
            lhWnd = FindTopVBWindow(GetActiveWindow(), hwnd)
            If lhWnd &lt;&gt; 0 Then
               SendMessage lhWnd, WM_NCACTIVATE, 1, ByVal 0&amp;
            End If
            lS = GetWindowLong(hwnd, GWL_STYLE)
            SetWindowLong hwnd, GWL_STYLE, lS And Not WS_VISIBLE
            
         End If
         bInHere = False
      End If
      
   Case Else
      WndProc = DefWindowProc(hwnd, iMsg, wParam, lParam)
   End Select
End Function
Private Function FindTopVBWindow(ByVal hWNdStart As Long, ByVal hWndVB As Long)
 As Long
Dim lhWnd As Long
   Do
      lhWnd = GetWindow(hWNdStart, GW_OWNER)
      If lhWnd = 0 Or lhWnd = hWndVB Then
         Exit Function
      Else
         FindTopVBWindow = lhWnd
         hWNdStart = lhWnd
      End If
   Loop
End Function




</pre><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p><p>&#160;</p></td><td class="rightbar" valign="top" bgcolor="#C2BEB1">
<!-- No right bar content currently defined -->
</td></tr><tr class="footer"><td></td>
<td>
<p class="center"></p>
</td>
<td></td>
</tr><tr><td colspan="3"><hr /></td></tr><tr class="footer"><td valign="top"><a href="http://www.vbaccelerator.com/home/index.asp"><img width="125" height="25" src="../../../../../res/vbaccelerator.png" alt="vbAccelerator Logo" /></a></td><td valign="bottom"><p class="nav"><a href="http://www.vbaccelerator.com/home/index.asp">Home</a>&#160;.&#160;<a href="../../../../index.html">VB</a>&#160;.&#160;<a href="../../../index.html">Code</a>&#160;.&#160;<a href="../../index.html">Controls</a>&#160;.&#160;<a href="../index.html">Drop Down Tool Windows</a>&#160;.&#160;<a href="article.html">vbAccelerator Drop-Down and Popup Form Control</a>&#160;.&#160;<a href="VB5_Drop_Down_Form_Control_Full_Source.html">VB5 Drop Down Form Control Full Source</a>&#160;.&#160;mTitleBarMod.bas</p><br /><p class="nav"><a href="http://www.vbaccelerator.com/home/The_Site/Copyright/article.asp">Copyright</a> &#169; 2003 Steve McMahon <a href="mailto:steve@vbaccelerator.com">steve@vbaccelerator.com</a>.  All rights reserved.<br />Last Updated: 12 April 2003</p></td><td></td></tr></table>
</body>
<!-- Mirrored from www.vbaccelerator.com/home/VB/Code/Controls/Drop_Down_Tool_Windows/Drop_Down_Form_Control/VB5_Drop_Down_Form_Control_Full_Source_zip_mTitleBarMod_bas.asp by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 19 Jun 2015 21:30:54 GMT -->
</html>